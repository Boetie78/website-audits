<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Workflow Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="mcp-development-fallback.js"></script>
    <script src="template-loader-fix.js"></script>
    <script src="create-customer-report-workflow.js"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">üéØ Complete Workflow: Create Folder ‚Üí Collect Data ‚Üí Generate Report</h1>

        <!-- Customer Selection -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">1. Select Customer</h2>
            <div class="mb-4">
                <select id="customerSelect" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    <option value="">Loading customers...</option>
                </select>
            </div>
            <div id="customerInfo" class="mt-4"></div>
        </div>

        <!-- Execute Complete Workflow -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">2. Execute Complete Workflow</h2>
            <p class="text-gray-600 mb-4">This will: Create customer folder ‚Üí Use MCPs to collect data ‚Üí Generate report</p>
            <button onclick="executeCompleteWorkflow()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
                üöÄ Execute Complete Workflow
            </button>
            <div id="workflowProgress" class="mt-4"></div>
        </div>

        <!-- Results -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">3. Workflow Results</h2>
            <div id="workflowResults"></div>
        </div>
    </div>

    <script>
        let selectedCustomer = null;

        window.addEventListener('load', function() {
            loadCustomers();
        });

        function loadCustomers() {
            try {
                const customers = JSON.parse(localStorage.getItem('website_audit_customers') || '[]');
                const select = document.getElementById('customerSelect');

                select.innerHTML = '<option value="">Select a customer...</option>';

                customers.forEach((customer, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${customer.companyName} - ${customer.website}`;
                    select.appendChild(option);
                });

                if (customers.length === 0) {
                    select.innerHTML = '<option value="">No customers found - Create one first</option>';
                }

                // Auto-select first customer if available
                if (customers.length > 0) {
                    select.value = 0;
                    loadSelectedCustomer();
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function loadSelectedCustomer() {
            const select = document.getElementById('customerSelect');
            const index = select.value;

            if (!index) return;

            try {
                const customers = JSON.parse(localStorage.getItem('website_audit_customers') || '[]');
                selectedCustomer = customers[parseInt(index)];

                const infoDiv = document.getElementById('customerInfo');
                infoDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="font-semibold text-green-800">${selectedCustomer.companyName}</h3>
                        <p class="text-green-600">Website: ${selectedCustomer.website}</p>
                        <p class="text-green-600">Industry: ${selectedCustomer.industry}</p>
                        <p class="text-green-600">Email: ${selectedCustomer.email}</p>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading customer:', error);
            }
        }

        // Add event listener for customer selection
        document.getElementById('customerSelect').addEventListener('change', loadSelectedCustomer);

        async function executeCompleteWorkflow() {
            if (!selectedCustomer) {
                alert('Please select a customer first');
                return;
            }

            const progressDiv = document.getElementById('workflowProgress');
            const resultsDiv = document.getElementById('workflowResults');

            progressDiv.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800">üîÑ Executing Complete Workflow</h4>
                    <div class="mt-2">
                        <div id="step1" class="text-blue-600">‚è≥ Step 1: Creating customer folder...</div>
                        <div id="step2" class="text-gray-400">‚è≥ Step 2: Collecting data via MCPs...</div>
                        <div id="step3" class="text-gray-400">‚è≥ Step 3: Generating report...</div>
                        <div id="step4" class="text-gray-400">‚è≥ Step 4: Saving to folder...</div>
                    </div>
                </div>
            `;

            try {
                console.log('üöÄ Starting complete workflow for:', selectedCustomer.companyName);

                // Execute the complete workflow
                const result = await window.customerReportWorkflow.executeCompleteWorkflow(selectedCustomer);

                // Update progress
                document.getElementById('step1').innerHTML = '‚úÖ Step 1: Customer folder created';
                document.getElementById('step1').className = 'text-green-600';

                document.getElementById('step2').innerHTML = '‚úÖ Step 2: Data collected via MCPs';
                document.getElementById('step2').className = 'text-green-600';

                document.getElementById('step3').innerHTML = '‚úÖ Step 3: Report generated';
                document.getElementById('step3').className = 'text-green-600';

                document.getElementById('step4').innerHTML = '‚úÖ Step 4: Saved to folder';
                document.getElementById('step4').className = 'text-green-600';

                // Show results
                resultsDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                        <h4 class="font-semibold text-green-800 text-lg">‚úÖ Workflow Completed Successfully!</h4>
                        <div class="mt-4 space-y-2">
                            <p class="text-green-700"><strong>Company:</strong> ${selectedCustomer.companyName}</p>
                            <p class="text-green-700"><strong>Folder Path:</strong> ${result.folderPath}</p>
                            <p class="text-green-700"><strong>Report Path:</strong> ${result.reportPath}</p>
                            <p class="text-green-700"><strong>Data Points Collected:</strong> ${result.dataCollected}</p>
                            <p class="text-green-700"><strong>Completed:</strong> ${new Date().toLocaleString()}</p>
                        </div>
                        <div class="mt-4 p-4 bg-white border border-green-200 rounded">
                            <h5 class="font-semibold text-green-800">Process Summary:</h5>
                            <ul class="mt-2 text-green-700 space-y-1">
                                <li>‚úÖ Customer folder structure created</li>
                                <li>‚úÖ Performance data collected via MCP Lighthouse</li>
                                <li>‚úÖ Backlinks data collected via MCP DataForSEO</li>
                                <li>‚úÖ Keywords data collected via MCP DataForSEO</li>
                                <li>‚úÖ Competitor data collected via MCP DataForSEO</li>
                                <li>‚úÖ Technical SEO data collected</li>
                                <li>‚úÖ All data stored in customer folder</li>
                                <li>‚úÖ Final report generated and saved</li>
                            </ul>
                        </div>
                    </div>
                `;

                console.log('‚úÖ Complete workflow executed successfully!');

            } catch (error) {
                console.error('‚ùå Workflow execution failed:', error);

                resultsDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h4 class="font-semibold text-red-800">‚ùå Workflow Failed</h4>
                        <p class="text-red-600 mt-2">Error: ${error.message}</p>
                        <p class="text-red-600">Check the console for detailed error information</p>
                    </div>
                `;
            }
        }


    </script>
</body>
</html>