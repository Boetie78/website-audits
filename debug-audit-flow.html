<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Audit Flow</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Load all necessary scripts in order -->
    <script src="customer-manager.js"></script>
    <script src="customer-audit-data-manager.js"></script>
    <script src="comprehensive-audit-data-collector.js"></script>
    <script src="automated-audit-system.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold mb-4">üîç Debug Audit Flow</h1>

        <div class="space-y-4">
            <div class="bg-blue-50 p-4 rounded">
                <h2 class="font-semibold mb-2">Current System Status</h2>
                <div id="systemStatus" class="space-y-1 text-sm"></div>
            </div>

            <div class="bg-green-50 p-4 rounded">
                <h2 class="font-semibold mb-2">Actions</h2>
                <div class="space-x-2">
                    <button onclick="createTestCustomer()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Create Test Customer
                    </button>
                    <button onclick="checkCustomers()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Check Customers
                    </button>
                    <button onclick="forceAuditCheck()" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">
                        Force Audit Check
                    </button>
                    <button onclick="clearAll()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                        Clear All Data
                    </button>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded">
                <h2 class="font-semibold mb-2">Debug Log</h2>
                <div id="debugLog" class="space-y-1 font-mono text-xs max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const debugLog = document.getElementById('debugLog');
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            div.className = type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : type === 'warning' ? 'text-orange-600' : 'text-blue-600';
            div.textContent = `[${timestamp}] ${message}`;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }

        function updateStatus(component, status) {
            const statusDiv = document.getElementById('systemStatus');
            const existing = statusDiv.querySelector(`[data-component="${component}"]`);
            if (existing) {
                existing.textContent = `${component}: ${status}`;
            } else {
                const div = document.createElement('div');
                div.setAttribute('data-component', component);
                div.textContent = `${component}: ${status}`;
                div.className = status.includes('‚úÖ') ? 'text-green-600' : status.includes('‚ùå') ? 'text-red-600' : 'text-blue-600';
                statusDiv.appendChild(div);
            }
        }

        function checkSystemComponents() {
            log('üîç Checking system components...');

            const components = {
                'Customer Manager': window.customerManager,
                'Audit Data Manager': window.customerAuditDataManager,
                'Comprehensive Collector': window.comprehensiveAuditDataCollector,
                'Automated Audit System': window.automatedAuditSystem
            };

            let allLoaded = true;
            for (const [name, component] of Object.entries(components)) {
                if (component) {
                    updateStatus(name, '‚úÖ Loaded');
                    log(`‚úÖ ${name} loaded successfully`, 'success');
                } else {
                    updateStatus(name, '‚ùå Missing');
                    log(`‚ùå ${name} not found`, 'error');
                    allLoaded = false;
                }
            }

            if (allLoaded) {
                log('üéâ All system components loaded!', 'success');
            } else {
                log('‚ö†Ô∏è Some components missing - audit flow may not work', 'warning');
            }

            return allLoaded;
        }

        async function createTestCustomer() {
            log('üß™ Creating test customer...');

            if (!window.customerManager) {
                log('‚ùå Customer Manager not available', 'error');
                return;
            }

            const testData = {
                companyName: 'Debug Test Company',
                contactName: 'Test User',
                email: 'debug@test.com',
                phone: '+27123456789',
                website: 'https://debugtest.co.za',
                industry: 'Technology',
                location: 'South Africa',
                competitors: ['https://competitor1.com', 'https://competitor2.com'],
                targetKeywords: ['debug test', 'technology solutions', 'software development']
            };

            try {
                const customer = await window.customerManager.createCustomerProject(testData);
                log(`‚úÖ Test customer created: ${customer.companyName} (ID: ${customer.id})`, 'success');
                log(`üìä Status: ${customer.status}, Progress: ${customer.auditProgress}%`);
                log(`üîó Report URL: ${customer.reportUrl}`);

                // Check if automated audit system picks it up
                setTimeout(() => {
                    log('‚è≥ Checking if automated audit system detected the new customer...', 'warning');
                    checkCustomers();
                }, 2000);

            } catch (error) {
                log(`‚ùå Error creating test customer: ${error.message}`, 'error');
            }
        }

        function checkCustomers() {
            log('üë• Checking current customers...');

            const customers = JSON.parse(localStorage.getItem('website_audit_customers') || '[]');
            log(`üì¶ Found ${customers.length} customers in localStorage`);

            customers.forEach((customer, index) => {
                log(`${index + 1}. ${customer.companyName} (${customer.id})`);
                log(`   Status: ${customer.status}, Progress: ${customer.auditProgress || 0}%`);
                log(`   Created: ${customer.createdAt}`);
                log(`   Website: ${customer.website}`);

                if (customer.auditData) {
                    log(`   ‚úÖ Has audit data`, 'success');
                } else {
                    log(`   ‚ùå No audit data yet`, 'warning');
                }
            });

            if (customers.length === 0) {
                log('üì≠ No customers found', 'warning');
            }
        }

        function forceAuditCheck() {
            log('üîß Forcing audit system to check for new customers...');

            if (!window.automatedAuditSystem) {
                log('‚ùå Automated Audit System not available', 'error');
                return;
            }

            try {
                // Manually trigger the customer check
                window.automatedAuditSystem.checkForNewCustomers();
                log('‚úÖ Manual audit check triggered', 'success');
            } catch (error) {
                log(`‚ùå Error triggering audit check: ${error.message}`, 'error');
            }
        }

        function clearAll() {
            log('üóëÔ∏è Clearing all customer data...');

            const keys = Object.keys(localStorage).filter(key =>
                key.includes('customer') || key.includes('audit') || key.includes('report')
            );

            keys.forEach(key => {
                localStorage.removeItem(key);
                log(`üóëÔ∏è Removed: ${key}`);
            });

            log(`‚úÖ Cleared ${keys.length} items from localStorage`, 'success');
        }

        // Auto-check system on load
        window.addEventListener('load', () => {
            log('üöÄ Debug system loaded');
            setTimeout(() => {
                checkSystemComponents();
                checkCustomers();
            }, 1000);
        });
    </script>
</body>
</html>